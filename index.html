<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pictionary YouTube Live</title>
<style>
body{font-family:sans-serif;background:#0f172a;color:#e2e8f0;padding:20px}
h1{color:#60a5fa;text-align:center}
input{width:100%;padding:10px;margin:6px 0;background:#1e293b;border:1px solid #3b82f6;color:white;border-radius:6px}
button{padding:10px 16px;border:none;border-radius:6px;background:#3b82f6;color:white;cursor:pointer;margin-right:10px}
button:disabled{opacity:0.5;cursor:not-allowed}
#drawingCanvas{display:none;border:2px solid #3b82f6;border-radius:8px;background:white;margin:10px 0}
.controls{display:none;margin-bottom:10px}
.status{text-align:center;margin-top:10px}
#errorBox{
  position:fixed;
  top:20px;
  left:20px;
  background:rgba(239,68,68,0.2);
  border:1px solid rgba(239,68,68,0.5);
  color:#fca5a5;
  padding:12px 16px;
  border-radius:8px;
  max-width:300px;
  font-size:14px;
  display:none;
  white-space:pre-wrap;
}
</style>
</head>
<body>
<h1>Pictionary YouTube Live</h1>

<div>
  <label>Secret Word:</label>
  <input type="text" id="secretWord" placeholder="Enter secret word">
  <label>YouTube API Key:</label>
  <input type="password" id="apiKey" placeholder="Enter API key">
  <label>Livestream Video ID:</label>
  <input type="text" id="videoId" placeholder="Enter live video ID">
</div>

<button id="startBtn">Start Monitoring</button>
<button id="stopBtn" disabled>Stop Monitoring</button>
<div class="status" id="status">Idle</div>

<canvas id="drawingCanvas" width="800" height="400"></canvas>
<div class="controls" id="drawingControls">
  <select id="colorPicker">
    <option value="#000000">Black</option>
    <option value="#3b82f6">Blue</option>
    <option value="#ef4444">Red</option>
    <option value="#10b981">Green</option>
    <option value="#fbbf24">Yellow</option>
  </select>
  <button id="clearCanvasBtn">Clear</button>
</div>

<div id="errorBox"></div>

<script>
let interval=null, liveChatId=null, checkedMessages=new Set();
const apiKeyInput=document.getElementById('apiKey');
const videoIdInput=document.getElementById('videoId');
const secretWordInput=document.getElementById('secretWord');
const startBtn=document.getElementById('startBtn');
const stopBtn=document.getElementById('stopBtn');
const statusDiv=document.getElementById('status');
const canvas=document.getElementById('drawingCanvas');
const ctx=canvas.getContext('2d');
const colorPicker=document.getElementById('colorPicker');
const clearCanvasBtn=document.getElementById('clearCanvasBtn');
const drawingControls=document.getElementById('drawingControls');
const errorBox=document.getElementById('errorBox');
let drawing=false;

// prikaz errorja
function showError(msg){
  console.error(msg);
  errorBox.textContent = "‚ùå " + msg;
  errorBox.style.display='block';
}

// retry pridobivanje liveChatId
async function getLiveChatId(videoId, apiKey, retries = 10) {
  for (let i = 0; i < retries; i++) {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoId}&key=${apiKey}`);
    const data = await res.json();

    if (data.items && data.items.length && data.items[0].liveStreamingDetails.activeLiveChatId) {
      return data.items[0].liveStreamingDetails.activeLiveChatId;
    }

    showError("Waiting for liveChatId... attempt " + (i+1));
    await new Promise(r => setTimeout(r, 5000)); // poƒçakaj 5s
  }
  throw new Error("Live chat ID ni najden. Preveri, ali je stream res LIVE in ima omogoƒçen chat.");
}

async function checkLiveChat(){
  const apiKey=apiKeyInput.value.trim();
  const secretWord=secretWordInput.value.trim().toLowerCase();
  if(!liveChatId) return;
  try{
    const res=await fetch(`https://www.googleapis.com/youtube/v3/liveChat/messages?liveChatId=${liveChatId}&part=snippet,authorDetails&key=${apiKey}`);
    const data=await res.json();

    if(data.error){
      showError("API error: " + data.error.message);
      return;
    }

    if(data.items){
      for(const item of data.items){
        const msgId=item.id;
        const msg=item.snippet.displayMessage.toLowerCase().trim();
        const user=item.authorDetails.displayName;
        if(checkedMessages.has(msgId)) continue;
        checkedMessages.add(msgId);
        if(msg===secretWord){
          alert(`üéâ WINNER: ${user} guessed the word "${secretWordInput.value}"`);
          stopMonitoring();
        }
      }
    }
    statusDiv.textContent=`Monitoring live chat... (${new Date().toLocaleTimeString()})`;
  }catch(e){
    showError("Fetch error: "+e.message);
  }
}

function startMonitoring(){
  const apiKey=apiKeyInput.value.trim();
  const videoId=videoIdInput.value.trim();
  const secretWord=secretWordInput.value.trim();
  errorBox.style.display='none';
  if(!apiKey||!videoId||!secretWord){showError("Missing input fields!");return;}

  document.getElementById('secretWord').style.display='none'; // skrij besedo
  canvas.style.display='block';
  drawingControls.style.display='flex';
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // risanje
  canvas.onmousedown=e=>{drawing=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);};
  canvas.onmousemove=e=>{if(drawing){ctx.strokeStyle=colorPicker.value;ctx.lineWidth=4;ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}};
  canvas.onmouseup=canvas.onmouseout=()=>{drawing=false;};
  clearCanvasBtn.onclick=()=>ctx.clearRect(0,0,canvas.width,canvas.height);

  startBtn.disabled=true;stopBtn.disabled=false;
  statusDiv.textContent='Getting live chat...';
  checkedMessages.clear();

  getLiveChatId(videoId,apiKey).then(id=>{
    liveChatId=id;
    errorBox.style.display='none';
    statusDiv.textContent='Monitoring live chat...';
    checkLiveChat();
    interval=setInterval(checkLiveChat,5000);
  }).catch(e=>{
    showError(e.message);
    stopMonitoring();
  });
}

function stopMonitoring(){
  if(interval){clearInterval(interval);interval=null;}
  startBtn.disabled=false;stopBtn.disabled=true;
  statusDiv.textContent='Stopped';
}

startBtn.onclick=startMonitoring;
stopBtn.onclick=stopMonitoring;
</script>
</body>
</html>
